#!/bin/sh
#
# o---------------------------------------------------------------------o
# |
# | COS generics (filter)
# |
# o---------------------------------------------------------------------o
# |
# | C Object System
# |
# | Copyright (c) 2007+ Laurent Deniau, laurent.deniau@cern.ch
# |
# | For more information, see:
# | http://cern.ch/laurent.deniau/cos.html
# |
# o---------------------------------------------------------------------o
# |
# | This file is part of the C Object System framework.
# |
# | The C Object System is free software; you can redistribute it and/or
# | modify it under the terms of the GNU Lesser General Public License
# | as published by the Free Software Foundation; either version 3 of
# | the License, or (at your option) any later version.
# |
# | The C Object System is distributed in the hope that it will be
# | useful, but WITHOUT ANY WARRANTY; without even the implied warranty
# | of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# |
# | See <http://www.gnu.org/licenses> for more details.
# |
# o---------------------------------------------------------------------o
# |
# | $Id: cosgen,v 1.2 2008/11/24 18:40:41 ldeniau Exp $
# |
#

# default settings
progname=`basename $0`
exedir=`dirname $0`
filelist=
out="_cosgen.c"
datestr=`date`

# helper
usage() {

cat <<END-OF-TEXT

  $progname extracts COS defgeneric from standard input and
  outputs a C file which must be compiled/linked with your project.

  Usage:
    $progname <options> files_to_include

  Options:
    --help
      This help.

    --in=<file_name>
      Use the content of file_name to specify list of files to include
      Multiple files can be provided with multiple --in

    --out=<file_name>
      Put the result in file_name
      Default is: $out

END-OF-TEXT

    exit 1
}

# parse arguments
while [ "$1" != "" ] ; do

	val=`expr $1 : '--in=\(.*\)'`
	if [ "$val" != "" ] ; then
		filelist="$filelist `cat $val`";
		shift; continue;
	fi

	val=`expr $1 : '--out=\(.*\)'`
	if [ "$val" != "" ] ; then
		out="$val";
		shift; continue;
	fi

	if [ "$1" = "--help" -o \
	     "$1" =  "-help" ] ; then
    usage
	fi

	val=`expr $1 : '--\(.*\)'`
	if [ "$val" != "" ] ; then
		echo "Unknown option: $1"
		usage
	fi

	filelist="$filelist $1"
	shift

done

# retrieve generics
gen=`cat - \
   | tr '\n' ' ' \
   | sed  -e 's/[ \t][ \t]*defgeneric[ \t]*(\([^;]*\);/\ndefgeneric(\1;\n/g' \
   | grep -E -e '^defgeneric\([^;]*;$' \
   | sed  -e 's/[ \t][ \t]*/ /g' -e 's/ \([,)\*]\)/\1/g' -e 's/( /(/g' \
   | sort -u -t ',' -k 2`

##### Start of _cosgen.c #####

mkdir -p `dirname $out`

cat > $out <<END-OF-TEXT
/*
 * -----------------------------
 * COS generics
 *
 * DO NOT EDIT - DO NOT EDIT - DO NOT EDIT
 * This file was automatically generated by $progname
 * $datestr
 * -----------------------------
 */

#include <cos/Object.h>

END-OF-TEXT

# includes
for f in $filelist; do
    f=`echo $f | sed -e 's:^.*include/::g'`
    echo "#include <$f>"                           >> $out
done
echo                                               >> $out

# makgenerics
echo "$gen" | sed -e 's/defgeneric(/makgeneric(/g' >> $out

##### Enf of _cosgen.c #####

# end of script
